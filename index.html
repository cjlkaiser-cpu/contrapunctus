<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Contrapunctus - Species Counterpoint Trainer</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #030712;
            --bg-secondary: #0f172a;
            --bg-tertiary: #1e293b;
            --accent: #a855f7;
            --accent-dim: #7c3aed;
            --text-primary: #f8fafc;
            --text-secondary: #94a3b8;
            --text-muted: #64748b;
            --success: #22c55e;
            --warning: #f59e0b;
            --error: #ef4444;
            --consonance-perfect: #22c55e;
            --consonance-imperfect: #3b82f6;
            --dissonance: #ef4444;
            --staff-line: #475569;
            --note-cf: #f97316;
            --note-cp: #a855f7;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', system-ui, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* Header */
        header {
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--bg-tertiary);
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .logo-icon {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, var(--accent), var(--accent-dim));
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
        }

        .logo h1 {
            font-size: 1.5rem;
            font-weight: 600;
            background: linear-gradient(135deg, var(--accent), #ec4899);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .logo-subtitle {
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-top: -2px;
        }

        .breadcrumb {
            font-size: 0.875rem;
            color: var(--text-muted);
        }

        .breadcrumb a {
            color: var(--text-secondary);
            text-decoration: none;
        }

        .breadcrumb a:hover {
            color: var(--accent);
        }

        /* Main Layout */
        main {
            display: grid;
            grid-template-columns: 280px 1fr 300px;
            gap: 0;
            min-height: calc(100vh - 65px);
        }

        /* Left Sidebar - Exercise Selection */
        .sidebar-left {
            background: var(--bg-secondary);
            border-right: 1px solid var(--bg-tertiary);
            padding: 1.5rem;
            overflow-y: auto;
        }

        .sidebar-section {
            margin-bottom: 2rem;
        }

        .sidebar-section h3 {
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-muted);
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .exercise-list {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .exercise-item {
            background: var(--bg-tertiary);
            border: 1px solid transparent;
            border-radius: 8px;
            padding: 0.75rem 1rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .exercise-item:hover {
            border-color: var(--accent-dim);
        }

        .exercise-item.active {
            border-color: var(--accent);
            background: rgba(168, 85, 247, 0.1);
        }

        .exercise-item .name {
            font-size: 0.875rem;
            font-weight: 500;
            margin-bottom: 0.25rem;
        }

        .exercise-item .meta {
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        .difficulty {
            display: inline-flex;
            gap: 2px;
        }

        .difficulty-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: var(--text-muted);
        }

        .difficulty-dot.active {
            background: var(--accent);
        }

        /* Species Selector */
        .species-tabs {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .species-tab {
            flex: 1;
            padding: 0.5rem;
            background: var(--bg-tertiary);
            border: 1px solid transparent;
            border-radius: 6px;
            color: var(--text-secondary);
            font-size: 0.75rem;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
        }

        .species-tab:hover {
            border-color: var(--accent-dim);
        }

        .species-tab.active {
            background: var(--accent);
            color: white;
            border-color: var(--accent);
        }

        .species-tab.locked {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Center - Staff Area */
        .staff-container {
            background: var(--bg-primary);
            padding: 2rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1.5rem;
        }

        .staff-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
            max-width: 900px;
        }

        .staff-title {
            font-size: 1.25rem;
            font-weight: 600;
        }

        .staff-controls {
            display: flex;
            gap: 0.5rem;
        }

        .btn {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            border: none;
            font-family: inherit;
        }

        .btn-primary {
            background: var(--accent);
            color: white;
        }

        .btn-primary:hover {
            background: var(--accent-dim);
        }

        .btn-secondary {
            background: var(--bg-tertiary);
            color: var(--text-primary);
            border: 1px solid var(--bg-tertiary);
        }

        .btn-secondary:hover {
            border-color: var(--accent-dim);
        }

        .btn-icon {
            padding: 0.5rem;
        }

        #staffCanvas {
            background: var(--bg-secondary);
            border-radius: 12px;
            cursor: crosshair;
            width: 100%;
            max-width: 900px;
            height: 300px;
            outline: none;
        }

        #staffCanvas:focus {
            box-shadow: 0 0 0 2px var(--accent);
        }

        /* Responsive adjustments */
        @media (max-width: 600px) {
            #staffCanvas {
                height: 250px;
            }

            .selection-hint {
                flex-wrap: wrap;
                gap: 0.5rem;
            }

            .selection-hint kbd {
                font-size: 0.6rem;
            }
        }

        /* Feedback Bar */
        .feedback-bar {
            width: 100%;
            max-width: 900px;
            background: var(--bg-secondary);
            border-radius: 8px;
            padding: 1rem 1.5rem;
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .feedback-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
        }

        .feedback-icon.success { background: rgba(34, 197, 94, 0.2); }
        .feedback-icon.warning { background: rgba(245, 158, 11, 0.2); }
        .feedback-icon.error { background: rgba(239, 68, 68, 0.2); }

        .feedback-content {
            flex: 1;
        }

        .feedback-title {
            font-weight: 500;
            margin-bottom: 0.25rem;
        }

        .feedback-message {
            font-size: 0.875rem;
            color: var(--text-secondary);
        }

        .feedback-score {
            text-align: right;
        }

        .score-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--accent);
        }

        .score-label {
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        /* Right Sidebar - Rules & Help */
        .sidebar-right {
            background: var(--bg-secondary);
            border-left: 1px solid var(--bg-tertiary);
            padding: 1.5rem;
            overflow-y: auto;
        }

        .rules-section {
            margin-bottom: 2rem;
        }

        .rules-section h3 {
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-muted);
            margin-bottom: 1rem;
        }

        .rule-item {
            display: flex;
            align-items: flex-start;
            gap: 0.75rem;
            padding: 0.75rem;
            background: var(--bg-tertiary);
            border-radius: 8px;
            margin-bottom: 0.5rem;
            font-size: 0.875rem;
        }

        .rule-icon {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            flex-shrink: 0;
        }

        .rule-icon.pass { background: var(--success); }
        .rule-icon.fail { background: var(--error); }
        .rule-icon.warn { background: var(--warning); }
        .rule-icon.pending { background: var(--text-muted); }

        .rule-text {
            color: var(--text-secondary);
            line-height: 1.4;
        }

        /* Interval Legend */
        .legend {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 0.5rem;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        .legend-color {
            width: 12px;
            height: 12px;
            border-radius: 3px;
        }

        /* Keyboard shortcuts */
        /* Instrument selector */
        .instrument-select {
            width: 100%;
            padding: 0.5rem;
            background: var(--bg-tertiary);
            border: 1px solid var(--bg-tertiary);
            border-radius: 6px;
            color: var(--text-primary);
            font-size: 0.875rem;
            font-family: inherit;
            cursor: pointer;
            transition: border-color 0.2s;
        }

        .instrument-select:hover {
            border-color: var(--accent-dim);
        }

        .instrument-select:focus {
            outline: none;
            border-color: var(--accent);
        }

        .instrument-status {
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-top: 0.5rem;
            min-height: 1rem;
        }

        .instrument-status.loading {
            color: var(--warning);
        }

        .instrument-status.ready {
            color: var(--success);
        }

        .instrument-status.error {
            color: var(--error);
        }

        .shortcuts {
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        .shortcut {
            display: flex;
            justify-content: space-between;
            padding: 0.5rem 0;
            border-bottom: 1px solid var(--bg-tertiary);
        }

        .shortcut:last-child {
            border-bottom: none;
        }

        kbd {
            background: var(--bg-tertiary);
            padding: 0.125rem 0.375rem;
            border-radius: 4px;
            font-family: monospace;
        }

        /* Modal */
        .modal-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 100;
            align-items: center;
            justify-content: center;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal {
            background: var(--bg-secondary);
            border-radius: 16px;
            padding: 2rem;
            max-width: 500px;
            width: 90%;
        }

        .modal h2 {
            margin-bottom: 1rem;
        }

        .modal p {
            color: var(--text-secondary);
            margin-bottom: 1.5rem;
            line-height: 1.6;
        }

        /* Theory Modal */
        .theory-modal {
            max-width: 700px;
            max-height: 85vh;
            display: flex;
            flex-direction: column;
        }

        .theory-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--bg-tertiary);
        }

        .theory-header h2 {
            margin: 0;
        }

        .theory-content {
            overflow-y: auto;
            padding-right: 0.5rem;
        }

        .theory-section {
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--bg-tertiary);
        }

        .theory-section:last-child {
            border-bottom: none;
        }

        .theory-section h3 {
            color: var(--accent);
            font-size: 1rem;
            margin-bottom: 0.75rem;
        }

        .theory-section h4 {
            color: var(--text-primary);
            font-size: 0.9rem;
            margin: 1rem 0 0.5rem 0;
        }

        .theory-section p {
            margin-bottom: 0.75rem;
            font-size: 0.875rem;
        }

        .theory-section ul {
            margin-left: 1.5rem;
            margin-bottom: 0.75rem;
        }

        .theory-section li {
            color: var(--text-secondary);
            font-size: 0.875rem;
            margin-bottom: 0.5rem;
            line-height: 1.5;
        }

        .theory-table {
            width: 100%;
            border-collapse: collapse;
            margin: 0.75rem 0;
            font-size: 0.8rem;
        }

        .theory-table th,
        .theory-table td {
            padding: 0.5rem;
            text-align: left;
            border: 1px solid var(--bg-tertiary);
        }

        .theory-table th {
            background: var(--bg-tertiary);
            color: var(--text-primary);
            font-weight: 500;
        }

        .theory-table td {
            color: var(--text-secondary);
        }

        .theory-table .good { color: var(--success); font-weight: 500; }
        .theory-table .caution { color: var(--warning); font-weight: 500; }
        .theory-table .bad { color: var(--error); font-weight: 500; }

        .theory-note {
            background: var(--bg-tertiary);
            padding: 0.75rem;
            border-radius: 6px;
            font-size: 0.8rem;
            border-left: 3px solid var(--accent);
        }

        .theory-section.source {
            opacity: 0.7;
            font-style: italic;
        }

        .theory-section.source p {
            font-size: 0.8rem;
        }

        /* Note hover preview */
        .note-preview {
            position: absolute;
            background: var(--bg-tertiary);
            padding: 0.5rem 0.75rem;
            border-radius: 6px;
            font-size: 0.75rem;
            pointer-events: none;
            z-index: 50;
            display: none;
        }

        .note-preview.visible {
            display: block;
        }

        /* Selection indicator */
        .selection-hint {
            background: var(--bg-tertiary);
            border-radius: 6px;
            padding: 0.5rem 1rem;
            font-size: 0.75rem;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .selection-hint .note-display {
            color: var(--accent);
            font-weight: 600;
            min-width: 60px;
        }

        .selection-hint kbd {
            background: var(--bg-secondary);
            padding: 0.125rem 0.375rem;
            border-radius: 4px;
            font-family: monospace;
            font-size: 0.7rem;
        }

        /* Responsive */
        @media (max-width: 1200px) {
            main {
                grid-template-columns: 1fr;
            }

            .sidebar-left, .sidebar-right {
                display: none;
            }
        }

        /* ==================== SCHOENBERG EXAMPLES ==================== */
        .examples-divider {
            height: 1px;
            background: var(--bg-tertiary);
            margin: 1.5rem 0;
        }

        .example-item {
            background: var(--bg-tertiary);
            border: 1px solid transparent;
            border-radius: 8px;
            padding: 0.75rem 1rem;
            cursor: pointer;
            transition: all 0.2s;
            margin-bottom: 0.5rem;
        }

        .example-item:hover {
            border-color: var(--accent-dim);
        }

        .example-item.active {
            border-color: var(--accent);
            background: rgba(168, 85, 247, 0.1);
        }

        .example-item .title {
            font-size: 0.875rem;
            font-weight: 500;
            margin-bottom: 0.25rem;
        }

        .example-item .info {
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        /* Examples Modal */
        .examples-modal {
            max-width: 900px;
            max-height: 90vh;
            display: flex;
            flex-direction: column;
        }

        .examples-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--bg-tertiary);
        }

        .examples-header h2 {
            margin: 0;
        }

        .examples-nav {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .examples-nav button {
            padding: 0.5rem 1rem;
            background: var(--bg-tertiary);
            border: 1px solid transparent;
            border-radius: 6px;
            color: var(--text-secondary);
            font-size: 0.875rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .examples-nav button:hover {
            border-color: var(--accent-dim);
        }

        .examples-nav button.active {
            background: var(--accent);
            color: white;
            border-color: var(--accent);
        }

        .examples-content {
            overflow-y: auto;
            flex: 1;
        }

        .cf-display {
            background: var(--bg-tertiary);
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
        }

        .cf-display h4 {
            color: var(--note-cf);
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
        }

        .cf-notes {
            font-family: monospace;
            font-size: 1.1rem;
            color: var(--text-primary);
            letter-spacing: 0.5em;
        }

        .solutions-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 1rem;
        }

        .solution-card {
            background: var(--bg-tertiary);
            border-radius: 8px;
            padding: 1rem;
            cursor: pointer;
            transition: all 0.2s;
            border: 2px solid transparent;
        }

        .solution-card:hover {
            border-color: var(--accent-dim);
        }

        .solution-card.selected {
            border-color: var(--accent);
            background: rgba(168, 85, 247, 0.1);
        }

        .solution-card.has-errors {
            border-left: 3px solid var(--error);
        }

        .solution-card.has-warnings {
            border-left: 3px solid var(--warning);
        }

        .solution-card.is-clean {
            border-left: 3px solid var(--success);
        }

        .solution-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .solution-id {
            font-weight: 600;
            font-size: 1rem;
        }

        .solution-position {
            font-size: 0.75rem;
            color: var(--text-muted);
            background: var(--bg-secondary);
            padding: 0.125rem 0.5rem;
            border-radius: 4px;
        }

        .solution-intervals {
            font-family: monospace;
            font-size: 0.9rem;
            color: var(--text-secondary);
            margin-bottom: 0.5rem;
            letter-spacing: 0.3em;
        }

        .solution-marks {
            display: flex;
            flex-wrap: wrap;
            gap: 0.25rem;
            margin-bottom: 0.5rem;
        }

        .mark-badge {
            font-size: 0.7rem;
            padding: 0.125rem 0.375rem;
            border-radius: 4px;
            font-weight: 500;
        }

        .mark-badge.error {
            background: rgba(239, 68, 68, 0.2);
            color: var(--error);
        }

        .mark-badge.warning {
            background: rgba(245, 158, 11, 0.2);
            color: var(--warning);
        }

        .mark-badge.info {
            background: rgba(100, 116, 139, 0.2);
            color: var(--text-muted);
        }

        .solution-comment {
            font-size: 0.75rem;
            color: var(--text-muted);
            font-style: italic;
        }

        .solution-detail {
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid var(--bg-tertiary);
        }

        .solution-detail h4 {
            color: var(--accent);
            margin-bottom: 0.75rem;
        }

        .detail-row {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
            font-size: 0.875rem;
        }

        .detail-label {
            color: var(--text-muted);
            min-width: 80px;
        }

        .detail-value {
            color: var(--text-primary);
            font-family: monospace;
        }

        .marks-legend {
            margin-top: 1rem;
            padding: 1rem;
            background: var(--bg-primary);
            border-radius: 8px;
        }

        .marks-legend h5 {
            color: var(--text-muted);
            font-size: 0.75rem;
            text-transform: uppercase;
            margin-bottom: 0.75rem;
        }

        .marks-legend-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 0.5rem;
        }

        .mark-legend-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.75rem;
        }

        /* Preview canvas for solutions */
        .solution-preview-container {
            margin-top: 1rem;
            padding: 1rem;
            background: var(--bg-primary);
            border-radius: 8px;
        }

        #solutionPreviewCanvas {
            width: 100%;
            height: 200px;
            background: var(--bg-secondary);
            border-radius: 8px;
        }

        .preview-controls {
            display: flex;
            gap: 0.5rem;
            margin-top: 0.75rem;
        }
    </style>
</head>
<body>
    <header>
        <div class="logo">
            <div class="logo-icon">‚ô´</div>
            <div>
                <h1>Contrapunctus</h1>
                <div class="logo-subtitle">Species Counterpoint Trainer</div>
            </div>
        </div>
        <nav class="breadcrumb">
            <a href="../../index.html">Physics Sound Lab</a> /
            <a href="../index.html">Generativos</a> /
            <span>Contrapunctus</span>
        </nav>
    </header>

    <main>
        <!-- Left Sidebar -->
        <aside class="sidebar-left">
            <div class="sidebar-section">
                <h3>Especie</h3>
                <div class="species-tabs">
                    <button class="species-tab active" data-species="1">1ra</button>
                    <button class="species-tab locked" data-species="2">2da</button>
                    <button class="species-tab locked" data-species="3">3ra</button>
                    <button class="species-tab locked" data-species="4">4ta</button>
                    <button class="species-tab locked" data-species="5">5ta</button>
                </div>
            </div>

            <div class="sidebar-section">
                <h3>Ejercicios</h3>
                <div class="exercise-list" id="exerciseList">
                    <!-- Filled by JS -->
                </div>
            </div>

            <div class="sidebar-section">
                <h3>Posicion del Contrapunto</h3>
                <div class="species-tabs">
                    <button class="species-tab active" data-position="upper">Superior</button>
                    <button class="species-tab" data-position="lower">Inferior</button>
                </div>
            </div>

            <div class="examples-divider"></div>

            <div class="sidebar-section">
                <h3>Ejemplos de Schoenberg</h3>
                <p style="font-size: 0.75rem; color: var(--text-muted); margin-bottom: 0.75rem;">
                    Estudia los ejemplos comentados del libro "Ejercicios Preliminares de Contrapunto"
                </p>
                <div id="schoenbergExamplesList">
                    <!-- Filled by JS -->
                </div>
            </div>
        </aside>

        <!-- Center - Staff -->
        <div class="staff-container">
            <div class="staff-header">
                <div class="staff-title" id="exerciseTitle">Primera Especie - Do Mayor</div>
                <div class="staff-controls">
                    <button class="btn btn-secondary btn-icon" id="btnUndo" title="Deshacer (Ctrl+Z)">‚Ü©</button>
                    <button class="btn btn-secondary btn-icon" id="btnClear" title="Limpiar">‚úï</button>
                    <button class="btn btn-secondary" id="btnPlay">‚ñ∂ Reproducir</button>
                    <button class="btn btn-primary" id="btnCheck">Verificar</button>
                    <button class="btn btn-secondary" id="btnExport" title="Exportar a MuseScore">‚Üì XML</button>
                </div>
            </div>

            <canvas id="staffCanvas" tabindex="0"></canvas>

            <div class="selection-hint" id="selectionHint">
                <span>Beat: <span class="note-display" id="selectedBeatDisplay">-</span></span>
                <span>Nota: <span class="note-display" id="selectedNoteDisplay">-</span></span>
                <span><kbd>‚Üë</kbd><kbd>‚Üì</kbd> diatonico</span>
                <span><kbd>Shift</kbd>+<kbd>‚Üë</kbd><kbd>‚Üì</kbd> cromatico</span>
                <span><kbd>‚Üê</kbd><kbd>‚Üí</kbd> navegar</span>
            </div>

            <div class="feedback-bar" id="feedbackBar">
                <div class="feedback-icon pending" id="feedbackIcon">?</div>
                <div class="feedback-content">
                    <div class="feedback-title" id="feedbackTitle">Escribe tu contrapunto</div>
                    <div class="feedback-message" id="feedbackMessage">
                        Haz clic en el pentagrama para colocar notas sobre el cantus firmus.
                    </div>
                </div>
                <div class="feedback-score">
                    <div class="score-value" id="scoreValue">--</div>
                    <div class="score-label">puntos</div>
                </div>
            </div>
        </div>

        <!-- Right Sidebar -->
        <aside class="sidebar-right">
            <!-- Theory Button -->
            <button class="btn btn-secondary" id="btnTheory" style="width: 100%; margin-bottom: 1rem;">
                üìñ Ver Teor√≠a (Schoenberg)
            </button>

            <div class="rules-section">
                <h3>Reglas Fundamentales</h3>
                <div id="rulesList">
                    <div class="rule-item" data-rules="CONSONANCE">
                        <div class="rule-icon pending">1</div>
                        <div class="rule-text">Solo consonancias (3as, 5as, 6as, 8as)</div>
                    </div>
                    <div class="rule-item" data-rules="PARALLEL_FIFTHS,PARALLEL_OCTAVES">
                        <div class="rule-icon pending">2</div>
                        <div class="rule-text">Sin quintas u octavas paralelas</div>
                    </div>
                    <div class="rule-item" data-rules="START_CONSONANCE">
                        <div class="rule-icon pending">3</div>
                        <div class="rule-text">Comenzar en consonancia perfecta</div>
                    </div>
                    <div class="rule-item" data-rules="END_CONSONANCE">
                        <div class="rule-icon pending">4</div>
                        <div class="rule-text">Terminar en un√≠sono u octava</div>
                    </div>
                    <div class="rule-item" data-rules="VOICE_CROSSING">
                        <div class="rule-icon pending">5</div>
                        <div class="rule-text">Sin cruce de voces</div>
                    </div>
                    <div class="rule-item" data-rules="MOTION_TYPE">
                        <div class="rule-icon pending">6</div>
                        <div class="rule-text">Preferir movimiento contrario</div>
                    </div>
                </div>
            </div>

            <div class="rules-section">
                <h3>Reglas Avanzadas (Schoenberg)</h3>
                <div id="advancedRulesList">
                    <div class="rule-item" data-rules="HIDDEN_FIFTHS,HIDDEN_OCTAVES">
                        <div class="rule-icon pending">7</div>
                        <div class="rule-text">Sin quintas/octavas ocultas</div>
                    </div>
                    <div class="rule-item" data-rules="BATTUTA_FIFTHS,BATTUTA_OCTAVES">
                        <div class="rule-icon pending">8</div>
                        <div class="rule-text">Sin paralelas intermitentes (¬ß8)</div>
                    </div>
                    <div class="rule-item" data-rules="COMPOUND_TRITONE">
                        <div class="rule-icon pending">9</div>
                        <div class="rule-text">Sin tritonos compuestos (¬ß7c)</div>
                    </div>
                    <div class="rule-item" data-rules="COMPOUND_DISSONANT_LEAP">
                        <div class="rule-icon pending">10</div>
                        <div class="rule-text">Sin saltos disonantes compuestos (¬ß7e)</div>
                    </div>
                    <div class="rule-item" data-rules="PROLONGED_DIRECTION">
                        <div class="rule-icon pending">11</div>
                        <div class="rule-text">M√°x 8-9 notas en una direcci√≥n (¬ß7f)</div>
                    </div>
                    <div class="rule-item" data-rules="ARPEGGIO,EXCESSIVE_PARALLELS">
                        <div class="rule-icon pending">12</div>
                        <div class="rule-text">Evitar arpegios y 3as/6as excesivas (¬ß7h)</div>
                    </div>
                </div>
            </div>

            <div class="rules-section">
                <h3>Intervalos</h3>
                <div class="legend">
                    <div class="legend-item">
                        <div class="legend-color" style="background: var(--consonance-perfect)"></div>
                        <span>Perf. (1, 5, 8)</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: var(--consonance-imperfect)"></div>
                        <span>Imperf. (3, 6)</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: var(--dissonance)"></div>
                        <span>Disonante</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background: var(--note-cf)"></div>
                        <span>Cantus Firmus</span>
                    </div>
                </div>
            </div>

            <div class="rules-section">
                <h3>Instrumento</h3>
                <select id="instrumentSelect" class="instrument-select">
                    <option value="synth">Sintetizador (built-in)</option>
                    <option value="choir_aahs">Coro (Aahs)</option>
                    <option value="church_organ">√ìrgano</option>
                    <option value="harpsichord">Clavec√≠n</option>
                    <option value="acoustic_grand_piano">Piano</option>
                    <option value="string_ensemble_1">Cuerdas</option>
                </select>
                <div id="instrumentStatus" class="instrument-status"></div>
            </div>

            <div class="rules-section">
                <h3>Atajos de Teclado</h3>
                <div class="shortcuts">
                    <div class="shortcut">
                        <span>Subir (diatonico)</span>
                        <kbd>‚Üë</kbd>
                    </div>
                    <div class="shortcut">
                        <span>Bajar (diatonico)</span>
                        <kbd>‚Üì</kbd>
                    </div>
                    <div class="shortcut">
                        <span>Alteracion (#/b)</span>
                        <kbd>Shift+‚Üë‚Üì</kbd>
                    </div>
                    <div class="shortcut">
                        <span>Beat anterior</span>
                        <kbd>‚Üê</kbd>
                    </div>
                    <div class="shortcut">
                        <span>Beat siguiente</span>
                        <kbd>‚Üí</kbd> <kbd>Tab</kbd>
                    </div>
                    <div class="shortcut">
                        <span>Borrar nota</span>
                        <kbd>Del</kbd>
                    </div>
                    <div class="shortcut">
                        <span>Reproducir</span>
                        <kbd>Space</kbd>
                    </div>
                    <div class="shortcut">
                        <span>Deshacer</span>
                        <kbd>Ctrl+Z</kbd>
                    </div>
                </div>
            </div>
        </aside>
    </main>

    <!-- Note preview tooltip -->
    <div class="note-preview" id="notePreview"></div>

    <!-- Success Modal -->
    <div class="modal-overlay" id="successModal">
        <div class="modal">
            <h2>üéâ Excelente!</h2>
            <p id="successMessage">Has completado el ejercicio correctamente.</p>
            <button class="btn btn-primary" id="btnNextExercise">Siguiente Ejercicio ‚Üí</button>
        </div>
    </div>

    <!-- Theory Modal -->
    <div class="modal-overlay" id="theoryModal">
        <div class="modal theory-modal">
            <div class="theory-header">
                <h2>üìñ Schoenberg - Primera Especie</h2>
                <button class="btn btn-secondary btn-icon" id="btnCloseTheory">‚úï</button>
            </div>
            <div class="theory-content" id="theoryContent">
                <!-- Introducci√≥n -->
                <section class="theory-section">
                    <h3>Definici√≥n General</h3>
                    <p>Adici√≥n de una voz (superior o inferior) a una voz dada llamada <em>cantus firmus</em> (CF). En la primera especie, la voz a√±adida se compone siempre de <strong>redondas</strong> (nota contra nota).</p>
                </section>

                <!-- ¬ß1 -->
                <section class="theory-section">
                    <h3>¬ß1. Regla Fundamental</h3>
                    <p>A cada nota del <em>cantus firmus</em> se le ha de a√±adir una <strong>nota consonante</strong>. La adici√≥n de notas consonantes solo est√° condicionada por las exigencias de la <strong>correcta conducci√≥n de las voces</strong>.</p>
                </section>

                <!-- ¬ß2 -->
                <section class="theory-section">
                    <h3>¬ß2. Consonancias</h3>
                    <p>Son consonancias (intervalos consonantes) las siguientes relaciones entre dos notas:</p>
                    <table class="theory-table">
                        <tr><th>Intervalo</th><th>Nombre</th><th>Observaci√≥n</th></tr>
                        <tr><td><strong>1</strong></td><td>Primera (un√≠sono)</td><td>No es un intervalo propiamente dicho</td></tr>
                        <tr><td><strong>8</strong></td><td>Octava</td><td>Por encima o por debajo</td></tr>
                        <tr><td><strong>5</strong></td><td>Quinta justa</td><td>Debe ser justa (no disminuida)</td></tr>
                        <tr><td><strong>3</strong></td><td>Tercera</td><td>Mayor o menor</td></tr>
                        <tr><td><strong>6</strong></td><td>Sexta</td><td>Mayor o menor</td></tr>
                    </table>
                </section>

                <!-- ¬ß3 -->
                <section class="theory-section">
                    <h3>¬ß3. Disonancias</h3>
                    <p>En la primera especie <strong>no se debe utilizar ning√∫n intervalo disonante</strong>.</p>
                    <table class="theory-table">
                        <tr><th>Intervalo</th><th>Nombre</th><th>Observaci√≥n</th></tr>
                        <tr><td><strong>2</strong></td><td>Segunda</td><td>Mayor o menor</td></tr>
                        <tr><td><strong>7</strong></td><td>S√©ptima</td><td>Mayor o menor</td></tr>
                        <tr><td><strong>9</strong></td><td>Novena</td><td>Segunda + octava</td></tr>
                        <tr><td><strong>4</strong></td><td>Cuarta</td><td class="caution">Tratada como disonancia a 2 voces</td></tr>
                        <tr><td><strong>+4</strong></td><td>Cuarta aumentada</td><td class="bad">Tritono</td></tr>
                        <tr><td><strong>-5</strong></td><td>Quinta disminuida</td><td class="bad">Inversi√≥n del tritono</td></tr>
                    </table>
                </section>

                <!-- ¬ß4 -->
                <section class="theory-section">
                    <h3>¬ß4. Intervalos Compuestos</h3>
                    <p>Todo intervalo <strong>conserva su calificaci√≥n</strong> de consonancia o disonancia aunque est√© ampliado en una o m√°s octavas.</p>
                    <ul>
                        <li>10¬™ (3¬™ + 8¬™) = <span class="good">consonancia</span></li>
                        <li>12¬™ (5¬™ + 8¬™) = <span class="good">consonancia</span></li>
                        <li>9¬™ (2¬™ + 8¬™) = <span class="bad">disonancia</span></li>
                        <li>14¬™ (7¬™ + 8¬™) = <span class="bad">disonancia</span></li>
                    </ul>
                </section>

                <!-- ¬ß6 -->
                <section class="theory-section">
                    <h3>¬ß6. Selecci√≥n de Voces</h3>
                    <p>El estudiante debe seleccionar siempre <strong>dos voces vecinas</strong>:</p>
                    <table class="theory-table">
                        <tr><th>Combinaci√≥n</th><th>V√°lida</th></tr>
                        <tr><td>Soprano - Contralto</td><td class="good">‚úì</td></tr>
                        <tr><td>Contralto - Tenor</td><td class="good">‚úì</td></tr>
                        <tr><td>Tenor - Bajo</td><td class="good">‚úì</td></tr>
                        <tr><td>Soprano - Tenor</td><td class="bad">‚úó</td></tr>
                        <tr><td>Soprano - Bajo</td><td class="bad">‚úó</td></tr>
                        <tr><td>Contralto - Bajo</td><td class="bad">‚úó</td></tr>
                    </table>
                </section>

                <!-- ¬ß7 -->
                <section class="theory-section">
                    <h3>¬ß7. Conducci√≥n Mel√≥dica de las Voces</h3>
                    <p>Las voces han de ser <strong>melodiosas</strong> o, al menos, <strong>no amel√≥dicas</strong>.</p>

                    <h4>¬ß7a-b. Intervalos aumentados y tritono</h4>
                    <ul>
                        <li>Usar solo notas naturales de la escala diat√≥nica</li>
                        <li>Quedan excluidas las progresiones crom√°ticas</li>
                        <li>La <strong>cuarta aumentada</strong> (tritono) entre las notas 4¬™ y 7¬™ debe ser <strong>estrictamente evitada</strong></li>
                    </ul>

                    <h4>¬ß7c. Tritonos compuestos</h4>
                    <p>Progresiones donde una o m√°s notas quedan insertas entre las notas 4¬™ y 7¬™ de la escala. Aunque no sean consecutivas, forman un tritono "oculto".</p>

                    <h4>¬ß7d-e. Saltos disonantes</h4>
                    <p>Evitar saltos con intervalos disonantes (7¬™, 9¬™, 11¬™). Tambi√©n evitar dos saltos sucesivos en la misma direcci√≥n que produzcan intervalos disonantes:</p>
                    <table class="theory-table">
                        <tr><th>Situaci√≥n</th><th>Resultado</th></tr>
                        <tr><td>4¬™ + 4¬™ = 7¬™</td><td class="bad">Mal</td></tr>
                        <tr><td>3¬™ + 5¬™ = 7¬™</td><td class="bad">Mal</td></tr>
                        <tr><td>5¬™ + 3¬™ = 7¬™</td><td class="bad">Mal</td></tr>
                        <tr><td>2¬™ + 6¬™ = 7¬™</td><td class="caution">Tolerable</td></tr>
                        <tr><td>3¬™ + 3¬™ = 5¬™</td><td class="good">Correcto</td></tr>
                    </table>

                    <h4>¬ß7f. Direcci√≥n prolongada</h4>
                    <p>M√°ximo <strong>8 o 9 notas</strong> en la misma direcci√≥n. Despu√©s de un salto, <strong>equilibrar</strong> mediante movimiento por grados conjuntos o salto en direcci√≥n opuesta. El mejor procedimiento: moverse en <strong>"ondas"</strong> arriba y abajo.</p>

                    <h4>¬ß7g. Salto de sexta</h4>
                    <p>Produce en muchos casos <strong>octavas o quintas ocultas</strong>. Es mejor evitarlo. En emergencia, puede emplearse la <strong>sexta menor ascendente</strong>.</p>

                    <h4>¬ß7h. Arpegios</h4>
                    <p>Evitar acordes arpegiados por dos razones:</p>
                    <ol>
                        <li>Expresan una armon√≠a, restringiendo el libre movimiento de las otras voces</li>
                        <li>Dan frecuentemente la impresi√≥n de un acompa√±amiento de estilo homof√≥nico</li>
                    </ol>

                    <h4>¬ß7i-j. Monoton√≠a y secuencias</h4>
                    <ul>
                        <li>No repetir frecuentemente una nota</li>
                        <li>No permanecer demasiado tiempo en el √°mbito de una cuarta o una quinta</li>
                        <li>Evitar repeticiones secuenciales (podr√≠an producir un "motivo" obligatorio)</li>
                    </ul>

                    <h4>¬ß7k. Salto de octava</h4>
                    <p><strong>Solo en emergencia:</strong> si se hubiese rebasado el √°mbito de la voz o si las voces se hubiesen acercado o alejado demasiado. <strong>No se permite salto alguno mayor que la octava.</strong></p>

                    <h4>¬ß7l. Principio general</h4>
                    <p class="theory-note">Una buena melod√≠a ha de <strong>mezclar los saltos con el movimiento por grados conjuntos</strong> y no proceder demasiado tiempo en una misma direcci√≥n. Normalmente, el mejor procedimiento ser√° moverse en "ondas" arriba y abajo.</p>
                </section>

                <!-- ¬ß8 -->
                <section class="theory-section">
                    <h3>¬ß8. Independencia de las Voces</h3>
                    <p>Las voces deben:</p>
                    <ol>
                        <li>Encontrarse en determinados puntos, en armon√≠as comprensibles</li>
                        <li>Expresar claramente la tonalidad</li>
                        <li>Ser tan independientes como resulte posible</li>
                    </ol>

                    <h4>I. Tres Tipos de Movimiento</h4>
                    <table class="theory-table">
                        <tr><th>Tipo</th><th>Descripci√≥n</th><th>Independencia</th></tr>
                        <tr><td><strong>Paralelo</strong></td><td>Misma direcci√≥n</td><td class="bad">Menor independencia</td></tr>
                        <tr><td><strong>Contrario</strong></td><td>Direcciones opuestas</td><td class="good">Mayor independencia</td></tr>
                        <tr><td><strong>Oblicuo</strong></td><td>Una voz estacionaria</td><td class="caution">No aplicable en 1¬™ especie</td></tr>
                    </table>

                    <h4>II. Reglas sobre Paralelas</h4>
                    <table class="theory-table">
                        <tr><th>Tipo</th><th>Regla</th></tr>
                        <tr><td>Octavas paralelas expl√≠citas</td><td class="bad">Evitar estrictamente</td></tr>
                        <tr><td>Quintas paralelas expl√≠citas</td><td class="bad">Evitar estrictamente</td></tr>
                        <tr><td>Octavas/quintas ocultas</td><td class="bad">Evitar (mov. paralelo hacia 8¬™ o 5¬™)</td></tr>
                        <tr><td>Terceras paralelas</td><td class="good">No son incorrectas</td></tr>
                        <tr><td>Sextas paralelas</td><td class="good">No son incorrectas</td></tr>
                    </table>
                    <p class="theory-note"><strong>Sobre terceras y sextas:</strong> No son nunca incorrectas, aunque el movimiento paralelo no debe utilizarse demasiado tiempo (m√°x. 3-4 consecutivas).</p>
                </section>

                <!-- ¬ß9 -->
                <section class="theory-section">
                    <h3>¬ß9. Cruzamiento de las Voces</h3>
                    <p><strong>Debe evitarse el cruzamiento de las voces.</strong> Aunque no es incorrecto, resulta un camino demasiado f√°cil para tratar los problemas.</p>
                    <p class="theory-note"><strong>Regla:</strong> Una voz inferior <strong>nunca</strong> debe utilizar una nota por encima de una voz superior, y viceversa.</p>
                </section>

                <!-- ¬ß10 -->
                <section class="theory-section">
                    <h3>¬ß10. Establecimiento de la Tonalidad</h3>
                    <p>La adhesi√≥n a una tonalidad es un modo b√°sico y efectivo de producir unidad.</p>

                    <h4>Regla para el comienzo y final:</h4>
                    <ul>
                        <li>Comenzar y acabar con elementos de la <strong>t√≥nica (I)</strong> en posici√≥n fundamental</li>
                        <li>La voz inferior solo puede tener <strong>la t√≥nica</strong> en el comienzo y final</li>
                    </ul>

                    <h4>La voz superior puede:</h4>
                    <ul>
                        <li>Duplicar la t√≥nica (a la primera o a la octava)</li>
                        <li>A√±adir la <strong>quinta</strong> (preferentemente)</li>
                        <li>A√±adir la <strong>tercera</strong> (en el comienzo, solo si al final no puede alcanzarse de otro modo)</li>
                    </ul>

                    <table class="theory-table">
                        <tr><th>Intervalo</th><th>Funci√≥n</th></tr>
                        <tr><td>1¬™ y 8¬™</td><td>Reservar para inicio y final</td></tr>
                        <tr><td>3¬™, 5¬™, 6¬™</td><td>Preferir durante el ejercicio</td></tr>
                    </table>
                </section>

                <!-- ¬ß11 -->
                <section class="theory-section">
                    <h3>¬ß11. Nota Antefinal (Pen√∫ltima)</h3>
                    <p>La nota antefinal se elegir√° siempre de las pertenecientes al <strong>acorde de dominante (V)</strong>:</p>
                    <ul>
                        <li><strong>Grado II</strong> de la escala (5¬™ del acorde de V)</li>
                        <li><strong>Grado VII</strong> (sensible ‚Üí resuelve a t√≥nica)</li>
                    </ul>
                    <p class="theory-note"><strong>Nunca</strong> usar la fundamental del IV grado (que coincide con la quinta disminuida del VII).</p>
                </section>

                <!-- Paralelas intermitentes -->
                <section class="theory-section">
                    <h3>Paralelas Intermitentes (Battuta)</h3>
                    <p>Han de evitarse las <strong>octavas y quintas paralelas intermitentes</strong> (llamadas tambi√©n <em>salteadas</em> o <em>no consecutivas</em>).</p>
                    <p>Aun cuando se insertase otra armon√≠a u otro intervalo entre dos encuentros casuales en una octava o quinta, se considerar√≠a a √©stas <strong>paralelas expl√≠citas</strong>.</p>

                    <h4>Excepci√≥n de Beethoven:</h4>
                    <p class="theory-note">Cuando una de las voces realiza un <strong>salto de cuarta o de quinta</strong>, las paralelas intermitentes pueden permitirse si, adem√°s, la segunda octava o quinta se aborda por <strong>movimiento contrario</strong>.</p>
                </section>

                <!-- Pecados -->
                <section class="theory-section">
                    <h3>Discriminaci√≥n entre "Pecados"</h3>
                    <p>Las severas restricciones hacen <strong>casi imposible escribir muchos ejemplos que no violen alguna que otra regla</strong>. Existe la posibilidad de discriminar entre "pecados" mayores y menores.</p>

                    <h4>Pecados menores (tolerables):</h4>
                    <table class="theory-table">
                        <tr><th>Situaci√≥n</th><th>Tolerancia</th></tr>
                        <tr><td>Sucesi√≥n ocasional de notas de un acorde arpegiado</td><td class="caution">Tolerable si compensada</td></tr>
                        <tr><td>Progresi√≥n larga en la misma direcci√≥n</td><td class="caution">Tolerable si compensada</td></tr>
                        <tr><td>Sucesi√≥n de saltos</td><td class="caution">Tolerable si compensada por m√©rito</td></tr>
                    </table>
                    <p class="theory-note">¬°El estudiante no va a publicar sus ejercicios, despu√©s de todo!</p>
                </section>

                <!-- M√©todo de trabajo -->
                <section class="theory-section">
                    <h3>M√©todo de Trabajo Recomendado</h3>
                    <p><strong>Siempre es aconsejable ir planteando los ejercicios un poco por delante</strong> y preguntarse qu√© dos o tres notas podr√≠an seguir a una dada.</p>
                    <p>Esta planificaci√≥n es <strong>casi imperativa para los finales</strong>. A menudo hay solo unas pocas posibilidades.</p>

                    <h4>Orden sistem√°tico:</h4>
                    <p>Proceder de modo sistem√°tico, acometiendo ejemplos que comiencen con:</p>
                    <ol>
                        <li>La <strong>primera</strong> (un√≠sono)</li>
                        <li>La <strong>octava</strong></li>
                        <li>La <strong>quinta</strong></li>
                        <li>La <strong>tercera</strong></li>
                    </ol>
                </section>

                <!-- Resumen -->
                <section class="theory-section">
                    <h3>Resumen de Reglas Principales</h3>

                    <h4>Intervalos permitidos:</h4>
                    <p><strong>1 (un√≠sono), 3, 5, 6, 8</strong></p>

                    <h4>Intervalos prohibidos:</h4>
                    <p><strong>2, 4, 7, 9 y todos los aumentados/disminuidos</strong></p>

                    <h4>Movimiento:</h4>
                    <ul>
                        <li>Preferir <strong>contrario</strong> sobre paralelo</li>
                        <li>Evitar <strong>todas</strong> las 8vas y 5tas paralelas (expl√≠citas, ocultas e intermitentes)</li>
                    </ul>

                    <h4>Melod√≠a:</h4>
                    <ul>
                        <li>Mezclar saltos con grados conjuntos</li>
                        <li>Moverse en "ondas"</li>
                        <li>Evitar tritono y sus compuestos</li>
                        <li>M√°ximo 8-9 notas en una direcci√≥n</li>
                    </ul>

                    <h4>Voces:</h4>
                    <ul>
                        <li>Solo voces vecinas</li>
                        <li>No cruzar voces</li>
                        <li>Mantener el √°mbito</li>
                    </ul>

                    <h4>Tonalidad:</h4>
                    <ul>
                        <li>Comenzar y terminar en t√≥nica (I)</li>
                        <li>Voz inferior = t√≥nica en inicio y final</li>
                        <li>Pen√∫ltima nota del acorde de V</li>
                    </ul>
                </section>

                <!-- Fuente -->
                <section class="theory-section source">
                    <h3>Fuente</h3>
                    <p>Arnold Schoenberg, <em>"Ejercicios Preliminares de Contrapunto"</em>, Primera Parte: Contrapunto Simple a Dos Voces, Primera Especie (pp. 19-33).</p>
                </section>
            </div>
        </div>
    </div>

    <!-- Schoenberg Examples Modal -->
    <div class="modal-overlay" id="examplesModal">
        <div class="modal examples-modal">
            <div class="examples-header">
                <h2 id="examplesModalTitle">Ejemplos de Schoenberg</h2>
                <button class="btn btn-secondary btn-icon" id="btnCloseExamples">‚úï</button>
            </div>

            <div class="examples-nav" id="examplesNav">
                <!-- Filled by JS -->
            </div>

            <div class="examples-content" id="examplesContent">
                <!-- Filled by JS -->
            </div>
        </div>
    </div>

    <!-- Core modules -->
    <script src="js/core/Pitch.js"></script>
    <script src="js/core/Interval.js"></script>
    <script src="js/core/Scale.js"></script>
    <script src="js/core/CantusFirmus.js"></script>
    <script src="js/validators/FirstSpeciesValidator.js"></script>
    <script src="js/data/SchoenbergExamples.js"></script>

    <script>
        // ==================== CONFIGURATION ====================
        const CONFIG = {
            staff: {
                x: 60,
                y: 80,
                lineSpacing: 12,
                noteSpacing: 80,
                clefWidth: 50
            },
            colors: {
                staffLine: '#475569',
                cantusFirmus: '#f97316',
                counterpoint: '#a855f7',
                counterpointPreview: 'rgba(168, 85, 247, 0.4)',
                perfectConsonance: '#22c55e',
                imperfectConsonance: '#3b82f6',
                dissonance: '#ef4444',
                ledgerLine: '#64748b'
            }
        };

        // ==================== STATE ====================
        const state = {
            currentExercise: null,
            counterpoint: [],
            cpPosition: 'upper',
            species: 1,
            audioContext: null,
            isPlaying: false,
            history: [],
            selectedBeat: 0,  // Currently selected beat for keyboard input
            // SoundFont state
            currentInstrument: 'synth',
            soundfont: null,
            soundfontLoading: false
        };

        // ==================== CANVAS SETUP ====================
        const canvas = document.getElementById('staffCanvas');
        const ctx = canvas.getContext('2d');

        // High DPI support with proper resize handling
        function setupCanvas() {
            const dpr = window.devicePixelRatio || 1;
            const rect = canvas.getBoundingClientRect();

            // Set actual size in memory (scaled for retina)
            canvas.width = rect.width * dpr;
            canvas.height = rect.height * dpr;

            // Reset transform before scaling (prevents accumulation)
            ctx.setTransform(1, 0, 0, 1, 0, 0);
            ctx.scale(dpr, dpr);

            // CSS size stays the same (controlled by CSS)
            // No need to set style.width/height since CSS handles it
        }

        // ==================== DRAWING ====================
        function draw() {
            const width = canvas.width / (window.devicePixelRatio || 1);
            const height = canvas.height / (window.devicePixelRatio || 1);

            // Clear
            ctx.fillStyle = '#0f172a';
            ctx.fillRect(0, 0, width, height);

            if (!state.currentExercise) return;

            const cf = state.currentExercise.notes;
            const noteCount = cf.length;

            // Calculate note positions - ensure all notes fit within staff
            const startX = CONFIG.staff.x + CONFIG.staff.clefWidth + 30;
            const availableWidth = width - startX - 60;
            const noteSpacing = availableWidth / noteCount;

            // Draw grand staff (treble + bass)
            drawStaff(CONFIG.staff.x, CONFIG.staff.y, width - 40, 'treble');
            drawStaff(CONFIG.staff.x, CONFIG.staff.y + 100, width - 40, 'bass');

            // Draw barlines
            ctx.strokeStyle = CONFIG.colors.staffLine;
            ctx.lineWidth = 1;

            // Initial barline
            ctx.beginPath();
            ctx.moveTo(CONFIG.staff.x, CONFIG.staff.y);
            ctx.lineTo(CONFIG.staff.x, CONFIG.staff.y + 100 + 48);
            ctx.stroke();

            // Final barline (double)
            const endX = width - 40;
            ctx.lineWidth = 1;
            ctx.beginPath();
            ctx.moveTo(endX - 4, CONFIG.staff.y);
            ctx.lineTo(endX - 4, CONFIG.staff.y + 100 + 48);
            ctx.stroke();
            ctx.lineWidth = 3;
            ctx.beginPath();
            ctx.moveTo(endX, CONFIG.staff.y);
            ctx.lineTo(endX, CONFIG.staff.y + 100 + 48);
            ctx.stroke();

            // Draw clefs
            drawClef(CONFIG.staff.x + 10, CONFIG.staff.y, 'treble');
            drawClef(CONFIG.staff.x + 10, CONFIG.staff.y + 100, 'bass');

            // Draw key signature indicator
            ctx.fillStyle = '#94a3b8';
            ctx.font = '14px Inter';
            ctx.fillText(state.currentExercise.key + ' ' +
                (state.currentExercise.mode === 'major' ? 'Mayor' : 'menor'),
                CONFIG.staff.x + CONFIG.staff.clefWidth + 5, CONFIG.staff.y - 10);

            // Draw notes
            for (let i = 0; i < noteCount; i++) {
                const x = startX + i * noteSpacing;

                // Draw selection highlight for selected beat
                if (i === state.selectedBeat) {
                    ctx.fillStyle = 'rgba(168, 85, 247, 0.15)';
                    ctx.fillRect(x - noteSpacing/2 + 5, CONFIG.staff.y - 20, noteSpacing - 10, 200);

                    // Selection indicator arrow at top
                    ctx.fillStyle = '#a855f7';
                    ctx.beginPath();
                    ctx.moveTo(x - 6, CONFIG.staff.y - 25);
                    ctx.lineTo(x + 6, CONFIG.staff.y - 25);
                    ctx.lineTo(x, CONFIG.staff.y - 15);
                    ctx.closePath();
                    ctx.fill();
                }

                // Draw CF note
                const cfNote = cf[i];
                drawNote(x, cfNote, CONFIG.colors.cantusFirmus, 'cf');

                // Draw CP note if exists
                if (state.counterpoint[i]) {
                    const cpNote = state.counterpoint[i];
                    drawNote(x, cpNote, CONFIG.colors.counterpoint, 'cp');

                    // Draw interval
                    drawInterval(x, cfNote, cpNote);
                }

                // Draw beat number (highlight if selected)
                ctx.fillStyle = i === state.selectedBeat ? '#a855f7' : '#64748b';
                ctx.font = i === state.selectedBeat ? 'bold 12px Inter' : '11px Inter';
                ctx.textAlign = 'center';
                ctx.fillText(i + 1, x, CONFIG.staff.y + 170);
            }

            // Update selection display
            updateSelectionDisplay();
        }

        function updateSelectionDisplay() {
            const beatDisplay = document.getElementById('selectedBeatDisplay');
            const noteDisplay = document.getElementById('selectedNoteDisplay');

            if (state.currentExercise && state.selectedBeat !== null) {
                beatDisplay.textContent = state.selectedBeat + 1;
                const note = state.counterpoint[state.selectedBeat];
                noteDisplay.textContent = note || '(vac√≠o)';
            } else {
                beatDisplay.textContent = '-';
                noteDisplay.textContent = '-';
            }
        }

        function drawStaff(x, y, width, clef) {
            ctx.strokeStyle = CONFIG.colors.staffLine;
            ctx.lineWidth = 1;

            for (let i = 0; i < 5; i++) {
                ctx.beginPath();
                ctx.moveTo(x, y + i * CONFIG.staff.lineSpacing);
                ctx.lineTo(width, y + i * CONFIG.staff.lineSpacing);
                ctx.stroke();
            }
        }

        function drawClef(x, y, type) {
            ctx.font = '48px serif';
            ctx.fillStyle = '#e2e8f0';

            if (type === 'treble') {
                ctx.fillText('ùÑû', x, y + 38);
            } else {
                ctx.fillText('ùÑ¢', x, y + 28);
            }
        }

        function getNoteY(noteStr) {
            // Map note to Y position on grand staff
            // Middle C (C4) is on the ledger line between staves
            const midi = Pitch.toMidi(noteStr);
            const middleC = 60;

            // Each step is half a line spacing
            const stepSize = CONFIG.staff.lineSpacing / 2;

            // Note positions (semitones don't affect vertical position, only letter names do)
            const parsed = Pitch.parse(noteStr);
            const letterIndex = Pitch.diatonicIndex(parsed.name);
            const octave = parsed.octave;

            // Calculate position relative to middle C (C4)
            // C4 letterIndex = 0, octave = 4
            const stepsFromC4 = letterIndex + (octave - 4) * 7;

            // C4 Y position is between the two staves
            const c4Y = CONFIG.staff.y + 60;

            // Each step up moves the note down (lower Y value)
            return c4Y - stepsFromC4 * stepSize;
        }

        function drawNote(x, noteStr, color, type) {
            const y = getNoteY(noteStr);

            // Draw ledger lines if needed
            drawLedgerLines(x, y, noteStr);

            // Draw note head (whole note)
            ctx.beginPath();
            ctx.ellipse(x, y, 8, 6, -0.2, 0, Math.PI * 2);
            ctx.strokeStyle = color;
            ctx.lineWidth = 2;
            ctx.stroke();

            // Parse note for accidentals
            const parsed = Pitch.parse(noteStr);

            // Draw accidental symbol if present (for counterpoint notes)
            if (type === 'cp' && parsed.accidental) {
                ctx.fillStyle = color;
                ctx.font = '16px serif';
                ctx.textAlign = 'right';
                const accSymbol = parsed.accidental === '#' ? '‚ôØ' : '‚ô≠';
                ctx.fillText(accSymbol, x - 12, y + 5);
            }

            // Note label for CF
            if (type === 'cf') {
                ctx.fillStyle = color;
                ctx.font = '10px Inter';
                ctx.textAlign = 'center';
                ctx.fillText(parsed.name + parsed.accidental, x, y + 20);
            }
        }

        function drawLedgerLines(x, y, noteStr) {
            ctx.strokeStyle = CONFIG.colors.ledgerLine;
            ctx.lineWidth = 1;

            // Treble staff bottom line Y
            const trebleBottom = CONFIG.staff.y + 4 * CONFIG.staff.lineSpacing;
            // Bass staff top line Y
            const bassTop = CONFIG.staff.y + 100;

            // Middle C position
            const middleCY = CONFIG.staff.y + 60;

            // Draw ledger lines for notes outside staff
            const lineY = CONFIG.staff.lineSpacing;

            // Above treble staff
            if (y < CONFIG.staff.y) {
                for (let ly = CONFIG.staff.y - lineY; ly >= y - lineY/2; ly -= lineY) {
                    ctx.beginPath();
                    ctx.moveTo(x - 12, ly);
                    ctx.lineTo(x + 12, ly);
                    ctx.stroke();
                }
            }

            // Below treble / above bass (middle C area)
            if (y > trebleBottom && y < bassTop) {
                // Middle C ledger line
                if (Math.abs(y - middleCY) < lineY) {
                    ctx.beginPath();
                    ctx.moveTo(x - 12, middleCY);
                    ctx.lineTo(x + 12, middleCY);
                    ctx.stroke();
                }
            }

            // Below bass staff
            const bassBottom = bassTop + 4 * CONFIG.staff.lineSpacing;
            if (y > bassBottom) {
                for (let ly = bassBottom + lineY; ly <= y + lineY/2; ly += lineY) {
                    ctx.beginPath();
                    ctx.moveTo(x - 12, ly);
                    ctx.lineTo(x + 12, ly);
                    ctx.stroke();
                }
            }
        }

        function drawInterval(x, cfNote, cpNote) {
            const interval = Interval.between(
                state.cpPosition === 'upper' ? cfNote : cpNote,
                state.cpPosition === 'upper' ? cpNote : cfNote
            );

            // Color based on consonance type
            let color;
            if (Interval.isPerfectConsonance(interval)) {
                color = CONFIG.colors.perfectConsonance;
            } else if (Interval.isImperfectConsonance(interval)) {
                color = CONFIG.colors.imperfectConsonance;
            } else {
                color = CONFIG.colors.dissonance;
            }

            // Draw interval label between notes
            const cfY = getNoteY(cfNote);
            const cpY = getNoteY(cpNote);
            const midY = (cfY + cpY) / 2;

            ctx.fillStyle = color;
            ctx.font = 'bold 11px Inter';
            ctx.textAlign = 'center';
            ctx.fillText(interval.simple.name, x + 18, midY + 4);
        }

        // ==================== INTERACTION ====================
        canvas.addEventListener('click', handleCanvasClick);
        canvas.addEventListener('mousemove', handleCanvasHover);

        function handleCanvasClick(e) {
            if (!state.currentExercise) return;

            // Block editing when viewing Schoenberg examples (read-only mode)
            if (examplesState.isViewingExample) {
                // Still allow focus for potential keyboard navigation
                canvas.focus();
                return;
            }

            // Focus the canvas for keyboard input
            canvas.focus();

            const rect = canvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;

            // Determine which beat was clicked
            const cf = state.currentExercise.notes;
            const noteCount = cf.length;
            const width = rect.width;
            const startX = CONFIG.staff.x + CONFIG.staff.clefWidth + 30;
            const availableWidth = width - startX - 60;
            const noteSpacing = availableWidth / noteCount;

            const beatIndex = Math.floor((x - startX + noteSpacing/2) / noteSpacing);

            if (beatIndex < 0 || beatIndex >= noteCount) return;

            // Select the beat
            state.selectedBeat = beatIndex;

            // Determine which note based on Y position
            const noteStr = yToNote(y);
            if (!noteStr) {
                draw();
                return;
            }

            // Check if note is in scale
            if (!Scale.containsNote(noteStr, state.currentExercise.key, state.currentExercise.mode)) {
                showFeedback('warning', 'Nota fuera de escala',
                    `${noteStr} no pertenece a ${state.currentExercise.key} ${state.currentExercise.mode}`);
                draw();
                return;
            }

            // Save to history for undo
            state.history.push([...state.counterpoint]);

            // Place note
            state.counterpoint[beatIndex] = noteStr;

            // Auto-advance to next beat
            if (state.selectedBeat < noteCount - 1) {
                state.selectedBeat++;
            }

            draw();
            validatePartial();
        }

        function handleCanvasHover(e) {
            const rect = canvas.getBoundingClientRect();
            const y = e.clientY - rect.top;

            const noteStr = yToNote(y);
            const preview = document.getElementById('notePreview');

            if (noteStr) {
                preview.textContent = noteStr;
                preview.style.left = (e.clientX + 15) + 'px';
                preview.style.top = (e.clientY - 10) + 'px';
                preview.classList.add('visible');
            } else {
                preview.classList.remove('visible');
            }
        }

        function yToNote(y) {
            // Convert Y position to note string
            const middleCY = CONFIG.staff.y + 60;
            const stepSize = CONFIG.staff.lineSpacing / 2;

            // Round to nearest step
            const stepsFromC4 = Math.round((middleCY - y) / stepSize);

            // Calculate note
            const octaveOffset = Math.floor(stepsFromC4 / 7);
            const letterOffset = ((stepsFromC4 % 7) + 7) % 7;

            const octave = 4 + octaveOffset;
            const letter = Pitch.DIATONIC_NAMES[letterOffset];

            // Apply key signature accidentals
            if (state.currentExercise) {
                const key = state.currentExercise.key;
                const keySig = Scale.KEY_SIGNATURES[key];

                if (keySig) {
                    if (keySig.sharpNotes && keySig.sharpNotes.includes(letter)) {
                        return letter + '#' + octave;
                    }
                    if (keySig.flatNotes && keySig.flatNotes.includes(letter)) {
                        return letter + 'b' + octave;
                    }
                }
            }

            return letter + octave;
        }

        // ==================== VALIDATION ====================
        function validatePartial() {
            // Quick validation as user works
            const filled = state.counterpoint.filter(n => n).length;
            const total = state.currentExercise.notes.length;

            if (filled === 0) {
                showFeedback('pending', 'Escribe tu contrapunto',
                    'Haz clic en el pentagrama para colocar notas.');
                return;
            }

            if (filled < total) {
                showFeedback('pending', `Progreso: ${filled}/${total} notas`,
                    'Continua colocando notas sobre el cantus firmus.');
                return;
            }

            // All notes placed, do full validation
            validateFull();
        }

        function validateFull() {
            const result = FirstSpeciesValidator.validate({
                cantusFirmus: state.currentExercise.notes,
                counterpoint: state.counterpoint,
                key: state.currentExercise.key,
                mode: state.currentExercise.mode,
                cpPosition: state.cpPosition
            });

            updateRulesDisplay(result);

            document.getElementById('scoreValue').textContent = result.score;

            if (result.valid) {
                showFeedback('success', 'Perfecto!',
                    'Tu contrapunto sigue todas las reglas.');

                if (result.score >= 90) {
                    showSuccessModal(result.score);
                }
            } else if (result.errors.length > 0) {
                showFeedback('error', `${result.errors.length} errores`,
                    result.errors[0].message);
            } else if (result.warnings.length > 0) {
                showFeedback('warning', 'Casi perfecto',
                    result.warnings[0].message);
            }

            draw();  // Redraw with error highlights
        }

        function updateRulesDisplay(result) {
            // Update rule indicators in sidebar using data-rules attributes
            const ruleElements = document.querySelectorAll('.rule-item[data-rules]');

            ruleElements.forEach((el, i) => {
                const icon = el.querySelector('.rule-icon');
                const rulesAttr = el.dataset.rules;
                const ruleNames = rulesAttr.split(',');
                const status = checkRule(result, ruleNames);

                icon.classList.remove('pass', 'fail', 'warn', 'pending');

                if (status === 'pass') {
                    icon.classList.add('pass');
                    icon.textContent = '‚úì';
                } else if (status === 'fail') {
                    icon.classList.add('fail');
                    icon.textContent = '‚úó';
                } else if (status === 'warn') {
                    icon.classList.add('warn');
                    icon.textContent = '!';
                } else {
                    icon.classList.add('pending');
                    icon.textContent = i + 1;
                }
            });
        }

        function checkRule(result, ruleNames) {
            // Check if any of the rule names match errors or warnings
            const hasError = result.errors.some(e => ruleNames.includes(e.rule));
            const hasWarning = result.warnings.some(w => ruleNames.includes(w.rule));
            const hasSuggestion = result.suggestions && result.suggestions.some(s => ruleNames.includes(s.rule));

            if (hasError) return 'fail';
            if (hasWarning) return 'warn';
            if (hasSuggestion) return 'warn';
            if (state.counterpoint.filter(n => n).length === state.currentExercise.notes.length) {
                return 'pass';
            }
            return 'pending';
        }

        // ==================== UI HELPERS ====================
        function showFeedback(type, title, message) {
            const icon = document.getElementById('feedbackIcon');
            const titleEl = document.getElementById('feedbackTitle');
            const messageEl = document.getElementById('feedbackMessage');

            icon.classList.remove('success', 'warning', 'error', 'pending');
            icon.classList.add(type);

            icon.textContent = type === 'success' ? '‚úì' :
                              type === 'error' ? '‚úó' :
                              type === 'warning' ? '!' : '?';

            titleEl.textContent = title;
            messageEl.textContent = message;
        }

        function showSuccessModal(score) {
            const modal = document.getElementById('successModal');
            const message = document.getElementById('successMessage');

            message.textContent = `Has completado el ejercicio con ${score} puntos. ` +
                (score === 100 ? 'Ejecucion perfecta!' : 'Muy buen trabajo!');

            // Small delay to prevent click event propagation from closing modal immediately
            modal.dataset.opening = 'true';
            modal.classList.add('active');
            setTimeout(() => {
                delete modal.dataset.opening;
            }, 100);
        }

        // ==================== EXERCISE LOADING ====================
        function loadExercise(id) {
            const cf = CantusFirmus.get(id);
            if (!cf) return;

            // Exit Schoenberg example mode if active
            if (examplesState.isViewingExample) {
                examplesState.isViewingExample = false;
                examplesState.currentExample = null;
                examplesState.currentSolution = null;
                document.querySelectorAll('#schoenbergExamplesList .example-item').forEach(el => {
                    el.classList.remove('active');
                });
                canvas.style.cursor = 'crosshair';
            }

            state.currentExercise = cf;
            state.counterpoint = new Array(cf.notes.length).fill(null);
            state.history = [];
            state.selectedBeat = 0;  // Reset selection to first beat

            document.getElementById('exerciseTitle').textContent =
                `Primera Especie - ${cf.name}`;

            // Update active state in list
            document.querySelectorAll('.exercise-item').forEach(el => {
                el.classList.toggle('active', el.dataset.id === id);
            });

            draw();
            validatePartial();
        }

        function populateExerciseList() {
            const list = document.getElementById('exerciseList');
            const exercises = CantusFirmus.getAll();

            list.innerHTML = exercises.map(cf => `
                <div class="exercise-item" data-id="${cf.id}">
                    <div class="name">${cf.name}</div>
                    <div class="meta">
                        ${cf.key} ${cf.mode === 'major' ? 'Mayor' : 'menor'} ‚Ä¢
                        <span class="difficulty">
                            ${[1,2,3].map(d => `<span class="difficulty-dot ${d <= cf.difficulty ? 'active' : ''}"></span>`).join('')}
                        </span>
                    </div>
                </div>
            `).join('');

            // Add click handlers
            list.querySelectorAll('.exercise-item').forEach(el => {
                el.addEventListener('click', () => loadExercise(el.dataset.id));
            });
        }

        // ==================== AUDIO ====================

        // smplr library for SoundFonts (loaded dynamically)
        let Soundfont = null;

        async function loadSmplr() {
            if (Soundfont) return;
            try {
                const module = await import('https://unpkg.com/smplr@0.15.1/dist/index.mjs');
                Soundfont = module.Soundfont;
            } catch (e) {
                console.warn('Could not load smplr, using synth fallback:', e);
            }
        }

        function initAudio() {
            if (!state.audioContext) {
                state.audioContext = new (window.AudioContext || window.webkitAudioContext)();

                // Create master compressor for smoother output
                state.masterGain = state.audioContext.createGain();
                state.masterGain.gain.value = 0.7;
                state.masterGain.connect(state.audioContext.destination);
            }
        }

        async function loadInstrument(instrumentName) {
            if (instrumentName === 'synth') {
                state.currentInstrument = 'synth';
                state.soundfont = null;
                updateInstrumentStatus('Sintetizador activo', 'ready');
                return;
            }

            initAudio();

            // Load smplr if not loaded
            if (!Soundfont) {
                updateInstrumentStatus('Cargando librer√≠a...', 'loading');
                await loadSmplr();
                if (!Soundfont) {
                    updateInstrumentStatus('Error cargando librer√≠a', 'error');
                    document.getElementById('instrumentSelect').value = 'synth';
                    return;
                }
            }

            state.soundfontLoading = true;
            updateInstrumentStatus('Cargando samples...', 'loading');

            try {
                const sf = new Soundfont(state.audioContext, {
                    instrument: instrumentName
                });
                await sf.load;

                state.soundfont = sf;
                state.currentInstrument = instrumentName;
                state.soundfontLoading = false;

                const names = {
                    'choir_aahs': 'Coro',
                    'church_organ': '√ìrgano',
                    'harpsichord': 'Clavec√≠n',
                    'acoustic_grand_piano': 'Piano',
                    'string_ensemble_1': 'Cuerdas'
                };
                updateInstrumentStatus(`${names[instrumentName] || instrumentName} listo`, 'ready');
            } catch (e) {
                console.error('Error loading instrument:', e);
                state.soundfontLoading = false;
                updateInstrumentStatus('Error cargando instrumento', 'error');
                document.getElementById('instrumentSelect').value = 'synth';
                state.currentInstrument = 'synth';
            }
        }

        function updateInstrumentStatus(message, className) {
            const status = document.getElementById('instrumentStatus');
            status.textContent = message;
            status.className = 'instrument-status ' + className;
        }

        function playNote(noteStr, time, duration) {
            const midi = Pitch.toMidi(noteStr);

            // Use SoundFont if available
            if (state.soundfont && state.currentInstrument !== 'synth') {
                state.soundfont.start({
                    note: midi,
                    velocity: 80,
                    time: time,
                    duration: duration
                });
                return;
            }

            // Fallback to synth
            playNoteSynth(noteStr, time, duration);
        }

        function playNoteSynth(noteStr, time, duration) {
            const freq = Pitch.midiToFreq(Pitch.toMidi(noteStr));
            const ctx = state.audioContext;

            // Create oscillator with slight detune for warmth
            const osc = ctx.createOscillator();
            const osc2 = ctx.createOscillator();

            osc.type = 'triangle';
            osc2.type = 'sine';
            osc.frequency.value = freq;
            osc2.frequency.value = freq;
            osc2.detune.value = 3;  // Slight detuning for chorus effect

            // Lowpass filter with envelope (key improvement)
            const filter = ctx.createBiquadFilter();
            filter.type = 'lowpass';
            filter.Q.value = 1.5;

            // Filter envelope: opens on attack, closes on release
            const baseFreq = Math.min(freq * 2, 2000);  // Relative to note pitch
            const peakFreq = Math.min(freq * 4, 4000);
            filter.frequency.setValueAtTime(baseFreq, time);
            filter.frequency.linearRampToValueAtTime(peakFreq, time + 0.05);  // Quick attack
            filter.frequency.exponentialRampToValueAtTime(baseFreq * 0.5, time + duration);  // Slow close

            // Amplitude envelope (ADSR-like)
            const gain = ctx.createGain();
            const gain2 = ctx.createGain();

            // Main oscillator envelope
            gain.gain.setValueAtTime(0.001, time);
            gain.gain.exponentialRampToValueAtTime(0.25, time + 0.02);  // Attack
            gain.gain.exponentialRampToValueAtTime(0.18, time + 0.1);   // Decay to sustain
            gain.gain.setValueAtTime(0.18, time + duration - 0.15);
            gain.gain.exponentialRampToValueAtTime(0.001, time + duration);  // Release

            // Secondary oscillator (softer, adds body)
            gain2.gain.setValueAtTime(0.001, time);
            gain2.gain.exponentialRampToValueAtTime(0.08, time + 0.03);
            gain2.gain.exponentialRampToValueAtTime(0.001, time + duration);

            // Connect: oscs -> gains -> filter -> master
            osc.connect(gain);
            osc2.connect(gain2);
            gain.connect(filter);
            gain2.connect(filter);
            filter.connect(state.masterGain);

            osc.start(time);
            osc2.start(time);
            osc.stop(time + duration + 0.1);
            osc2.stop(time + duration + 0.1);
        }

        function playExercise() {
            if (state.isPlaying) return;
            if (!state.currentExercise) return;
            if (state.soundfontLoading) return;  // Wait for instrument to load

            initAudio();
            state.isPlaying = true;

            const cf = state.currentExercise.notes;
            const tempo = 60;  // BPM
            const beatDuration = 60 / tempo;
            let time = state.audioContext.currentTime + 0.1;

            for (let i = 0; i < cf.length; i++) {
                // Play CF note
                playNote(cf[i], time, beatDuration * 0.9);

                // Play CP note if exists
                if (state.counterpoint[i]) {
                    playNote(state.counterpoint[i], time, beatDuration * 0.9);
                }

                time += beatDuration;
            }

            setTimeout(() => {
                state.isPlaying = false;
            }, cf.length * beatDuration * 1000 + 200);
        }

        // ==================== MUSICXML EXPORT ====================

        function generateMusicXML() {
            if (!state.currentExercise) return null;

            const cf = state.currentExercise.notes;
            const cp = state.counterpoint;
            const title = state.currentExercise.name;
            const key = state.currentExercise.key;

            // Parse note to MusicXML format
            function parseNote(noteStr) {
                const parsed = Pitch.parse(noteStr);
                let step = parsed.name;
                let alter = 0;
                if (parsed.accidental === '#') alter = 1;
                if (parsed.accidental === 'b') alter = -1;
                return { step, alter, octave: parsed.octave };
            }

            // Generate measures
            let cfMeasures = '';
            let cpMeasures = '';

            for (let i = 0; i < cf.length; i++) {
                const cfNote = parseNote(cf[i]);
                const cpNote = cp[i] ? parseNote(cp[i]) : null;

                // CF measure
                cfMeasures += `
      <measure number="${i + 1}">
        ${i === 0 ? `<attributes>
          <divisions>1</divisions>
          <key><fifths>${getKeyFifths(key)}</fifths></key>
          <time><beats>4</beats><beat-type>4</beat-type></time>
          <clef><sign>F</sign><line>4</line></clef>
        </attributes>` : ''}
        <note>
          <pitch>
            <step>${cfNote.step}</step>
            ${cfNote.alter !== 0 ? `<alter>${cfNote.alter}</alter>` : ''}
            <octave>${cfNote.octave}</octave>
          </pitch>
          <duration>4</duration>
          <type>whole</type>
        </note>
      </measure>`;

                // CP measure
                cpMeasures += `
      <measure number="${i + 1}">
        ${i === 0 ? `<attributes>
          <divisions>1</divisions>
          <key><fifths>${getKeyFifths(key)}</fifths></key>
          <time><beats>4</beats><beat-type>4</beat-type></time>
          <clef><sign>G</sign><line>2</line></clef>
        </attributes>` : ''}
        ${cpNote ? `<note>
          <pitch>
            <step>${cpNote.step}</step>
            ${cpNote.alter !== 0 ? `<alter>${cpNote.alter}</alter>` : ''}
            <octave>${cpNote.octave}</octave>
          </pitch>
          <duration>4</duration>
          <type>whole</type>
        </note>` : `<note><rest/><duration>4</duration><type>whole</type></note>`}
      </measure>`;
            }

            // Build complete MusicXML
            const xml = `<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE score-partwise PUBLIC "-//Recordare//DTD MusicXML 3.1 Partwise//EN" "http://www.musicxml.org/dtds/partwise.dtd">
<score-partwise version="3.1">
  <work>
    <work-title>${title} - Primera Especie</work-title>
  </work>
  <identification>
    <creator type="composer">Contrapunctus</creator>
    <encoding>
      <software>Contrapunctus - Species Counterpoint Trainer</software>
      <encoding-date>${new Date().toISOString().split('T')[0]}</encoding-date>
    </encoding>
  </identification>
  <part-list>
    <score-part id="P1">
      <part-name>Contrapunto</part-name>
    </score-part>
    <score-part id="P2">
      <part-name>Cantus Firmus</part-name>
    </score-part>
  </part-list>
  <part id="P1">${cpMeasures}
  </part>
  <part id="P2">${cfMeasures}
  </part>
</score-partwise>`;

            return xml;
        }

        function getKeyFifths(key) {
            // Circle of fifths: C=0, G=1, D=2, etc. F=-1, Bb=-2, etc.
            const fifths = {
                'C': 0, 'G': 1, 'D': 2, 'A': 3, 'E': 4, 'B': 5,
                'F': -1, 'Bb': -2, 'Eb': -3, 'Ab': -4, 'Db': -5
            };
            return fifths[key] || 0;
        }

        function exportMusicXML() {
            const xml = generateMusicXML();
            if (!xml) {
                alert('No hay ejercicio para exportar');
                return;
            }

            // Create and download file
            const blob = new Blob([xml], { type: 'application/vnd.recordare.musicxml+xml' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `contrapunctus-${state.currentExercise.id}.musicxml`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // ==================== EVENT HANDLERS ====================
        document.getElementById('btnPlay').addEventListener('click', playExercise);

        document.getElementById('btnCheck').addEventListener('click', validateFull);

        document.getElementById('btnClear').addEventListener('click', () => {
            state.history.push([...state.counterpoint]);
            state.counterpoint = new Array(state.currentExercise.notes.length).fill(null);
            draw();
            validatePartial();
        });

        document.getElementById('btnUndo').addEventListener('click', () => {
            if (state.history.length > 0) {
                state.counterpoint = state.history.pop();
                draw();
                validatePartial();
            }
        });

        document.getElementById('btnNextExercise').addEventListener('click', () => {
            document.getElementById('successModal').classList.remove('active');
            // Load next exercise
            const exercises = CantusFirmus.getAll();
            const currentIdx = exercises.findIndex(e => e.id === state.currentExercise.id);
            const nextIdx = (currentIdx + 1) % exercises.length;
            loadExercise(exercises[nextIdx].id);
        });

        document.getElementById('successModal').addEventListener('click', (e) => {
            // Ignore clicks while modal is opening (prevents immediate close from event propagation)
            if (e.target.dataset.opening) return;
            if (e.target.id === 'successModal') {
                e.target.classList.remove('active');
            }
        });

        // Theory modal handlers
        document.getElementById('btnTheory').addEventListener('click', () => {
            document.getElementById('theoryModal').classList.add('active');
        });

        document.getElementById('btnCloseTheory').addEventListener('click', () => {
            document.getElementById('theoryModal').classList.remove('active');
        });

        document.getElementById('theoryModal').addEventListener('click', (e) => {
            if (e.target.id === 'theoryModal') {
                e.target.classList.remove('active');
            }
        });

        // ==================== SCHOENBERG EXAMPLES ====================

        // State for examples viewer
        const examplesState = {
            currentExample: null,
            currentSolution: null,
            isViewingExample: false  // Flag to indicate we're viewing an example (read-only mode)
        };

        // Populate the sidebar list with Schoenberg examples
        function populateSchoenbergExamplesList() {
            const container = document.getElementById('schoenbergExamplesList');
            if (!container || typeof SchoenbergExamples === 'undefined') return;

            container.innerHTML = '';

            const examples = SchoenbergExamples.getAll();
            examples.forEach(example => {
                const div = document.createElement('div');
                div.className = 'example-item';
                div.dataset.exampleId = example.id;
                div.innerHTML = `
                    <div class="title">${example.title}</div>
                    <div class="info">${example.cf.description} ¬∑ ${example.solutions.length} soluciones ¬∑ p.${example.page}</div>
                `;
                div.addEventListener('click', () => loadSchoenbergExample(example.id));
                container.appendChild(div);
            });
        }

        // Load a Schoenberg example into the main canvas
        function loadSchoenbergExample(exampleId, solutionId = 'a') {
            const example = SchoenbergExamples.get(exampleId);
            if (!example) return;

            const solution = example.solutions.find(s => s.id === solutionId) || example.solutions[0];
            if (!solution) return;

            // Update state
            examplesState.currentExample = exampleId;
            examplesState.currentSolution = solution.id;
            examplesState.isViewingExample = true;

            // Calculate CP notes from intervals
            const cpNotes = SchoenbergExamples.calculateCPNotes(
                example.cf.notes,
                solution.intervals,
                solution.position,
                example.key,
                example.mode
            );

            // Update main state (same as regular exercises)
            state.currentExercise = {
                id: `schoenberg-${exampleId}`,
                name: `${example.title} - ${example.cf.description}`,
                key: example.key,
                mode: example.mode,
                notes: example.cf.notes,
                source: `Schoenberg p.${example.page}`
            };
            state.counterpoint = cpNotes;
            state.cpPosition = solution.position === 'arriba' ? 'upper' : 'lower';

            // Update UI
            updateExampleUI(example, solution);

            // Highlight selected example in sidebar
            document.querySelectorAll('#schoenbergExamplesList .example-item').forEach(el => {
                el.classList.toggle('active', el.dataset.exampleId === exampleId);
            });

            // Open the solution selector modal
            openSolutionSelector(example, solution);

            // Redraw canvas
            draw();
        }

        // Update UI elements for viewing an example
        function updateExampleUI(example, solution) {
            // Update title
            document.getElementById('exerciseTitle').textContent =
                `${example.title} (${solution.id.toUpperCase()}) - ${example.key} ${example.mode === 'major' ? 'Mayor' : 'menor'}`;

            // Update feedback bar with Schoenberg marks
            updateFeedbackWithMarks(solution);

            // Disable editing UI (visual indication)
            canvas.style.cursor = 'default';
        }

        // Update the feedback bar with Schoenberg marks
        function updateFeedbackWithMarks(solution) {
            const feedbackIcon = document.getElementById('feedbackIcon');
            const feedbackTitle = document.getElementById('feedbackTitle');
            const feedbackMessage = document.getElementById('feedbackMessage');
            const scoreValue = document.getElementById('scoreValue');

            // Determine severity
            const hasErrors = solution.marks.some(m =>
                SchoenbergExamples.MARKS[m]?.severity === 'error'
            );
            const hasWarnings = solution.marks.some(m =>
                SchoenbergExamples.MARKS[m]?.severity === 'warning'
            );
            const isClean = solution.marks.length === 0 && !solution.isError;

            // Update icon
            feedbackIcon.className = 'feedback-icon';
            if (solution.isError) {
                feedbackIcon.classList.add('error');
                feedbackIcon.textContent = '‚úó';
            } else if (hasErrors) {
                feedbackIcon.classList.add('error');
                feedbackIcon.textContent = '!';
            } else if (hasWarnings) {
                feedbackIcon.classList.add('warning');
                feedbackIcon.textContent = '‚ö†';
            } else if (isClean) {
                feedbackIcon.classList.add('success');
                feedbackIcon.textContent = '‚úì';
            } else {
                feedbackIcon.textContent = 'üìñ';
            }

            // Update title
            feedbackTitle.textContent = isClean
                ? 'Soluci√≥n correcta'
                : solution.isError
                    ? 'Ejemplo de error'
                    : 'Soluci√≥n con observaciones';

            // Build marks display
            let marksHtml = '';
            if (solution.marks.length > 0) {
                marksHtml = solution.marks.map(markKey => {
                    const mark = SchoenbergExamples.MARKS[markKey];
                    if (!mark) return '';
                    return `<span class="mark-badge ${mark.severity}" title="${mark.name}">${mark.symbol}</span>`;
                }).join(' ');
            }

            feedbackMessage.innerHTML = solution.comment
                ? `${marksHtml} ${solution.comment}`
                : marksHtml || 'Sin observaciones de Schoenberg';

            // Score based on marks
            if (isClean) {
                scoreValue.textContent = '100';
            } else {
                const errorCount = solution.marks.filter(m =>
                    SchoenbergExamples.MARKS[m]?.severity === 'error').length;
                const warnCount = solution.marks.filter(m =>
                    SchoenbergExamples.MARKS[m]?.severity === 'warning').length;
                scoreValue.textContent = Math.max(0, 100 - errorCount * 25 - warnCount * 10);
            }
        }

        // Open the solution selector modal
        function openSolutionSelector(example, currentSolution) {
            // Update modal title
            document.getElementById('examplesModalTitle').textContent =
                `${example.title} - Seleccionar Soluci√≥n`;

            // Render navigation between examples
            renderExamplesNav();

            // Render solution selector
            renderSolutionSelector(example, currentSolution);

            document.getElementById('examplesModal').classList.add('active');
        }

        // Render the navigation tabs for examples
        function renderExamplesNav() {
            const nav = document.getElementById('examplesNav');
            const examples = SchoenbergExamples.getAll();

            nav.innerHTML = examples.map(ex => `
                <button data-example="${ex.id}" class="${ex.id === examplesState.currentExample ? 'active' : ''}">
                    ${ex.title}
                </button>
            `).join('');

            nav.querySelectorAll('button').forEach(btn => {
                btn.addEventListener('click', () => {
                    loadSchoenbergExample(btn.dataset.example);
                });
            });
        }

        // Render solution selector inside modal
        function renderSolutionSelector(example, currentSolution) {
            const container = document.getElementById('examplesContent');

            // CF display
            const cfHtml = `
                <div class="cf-display">
                    <h4>Cantus Firmus (${example.cf.description})</h4>
                    <div class="cf-notes">${example.cf.notes.join(' ')}</div>
                </div>
            `;

            // Solutions grid
            const solutionsHtml = `
                <div class="solutions-grid">
                    ${example.solutions.map(sol => renderSolutionCard(sol, example, currentSolution)).join('')}
                </div>
            `;

            // Marks legend
            const marksLegendHtml = `
                <div class="marks-legend">
                    <h5>Leyenda de marcas</h5>
                    <div class="marks-legend-grid">
                        ${Object.entries(SchoenbergExamples.MARKS).map(([key, mark]) => `
                            <div class="mark-legend-item">
                                <span class="mark-badge ${mark.severity}">${mark.symbol}</span>
                                <span>${mark.name}</span>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;

            container.innerHTML = cfHtml + solutionsHtml + marksLegendHtml;

            // Add click handlers
            container.querySelectorAll('.solution-card').forEach(card => {
                card.addEventListener('click', () => {
                    const solId = card.dataset.solution;
                    loadSchoenbergExample(examplesState.currentExample, solId);
                });
            });
        }

        // Render a single solution card
        function renderSolutionCard(solution, example, currentSolution) {
            const isSelected = currentSolution && solution.id === currentSolution.id;
            const hasErrors = solution.marks.some(m =>
                SchoenbergExamples.MARKS[m]?.severity === 'error'
            );
            const hasWarnings = solution.marks.some(m =>
                SchoenbergExamples.MARKS[m]?.severity === 'warning'
            );
            const isClean = solution.marks.length === 0 && !solution.isError;

            let statusClass = '';
            if (solution.isError) statusClass = 'has-errors';
            else if (hasErrors) statusClass = 'has-errors';
            else if (hasWarnings) statusClass = 'has-warnings';
            else if (isClean) statusClass = 'is-clean';

            const marksHtml = solution.marks.map(markKey => {
                const mark = SchoenbergExamples.MARKS[markKey];
                if (!mark) return '';
                return `<span class="mark-badge ${mark.severity}">${mark.symbol}</span>`;
            }).join('');

            const intervalsStr = solution.intervals.map(i => i === null ? '?' : i).join(' ');

            return `
                <div class="solution-card ${statusClass} ${isSelected ? 'selected' : ''}" data-solution="${solution.id}">
                    <div class="solution-header">
                        <span class="solution-id">${solution.id.toUpperCase()})</span>
                        <span class="solution-position">${solution.position === 'arriba' ? '‚Üë Sup' : '‚Üì Inf'}</span>
                    </div>
                    <div class="solution-intervals">${intervalsStr}</div>
                    ${marksHtml ? `<div class="solution-marks">${marksHtml}</div>` : ''}
                    ${solution.comment ? `<div class="solution-comment">${solution.comment}</div>` : ''}
                </div>
            `;
        }

        // Exit example viewing mode and return to practice
        function exitExampleMode() {
            examplesState.isViewingExample = false;
            examplesState.currentExample = null;
            examplesState.currentSolution = null;

            // Clear selection in sidebar
            document.querySelectorAll('#schoenbergExamplesList .example-item').forEach(el => {
                el.classList.remove('active');
            });

            // Restore cursor
            canvas.style.cursor = 'crosshair';

            // Load a regular exercise
            const exercises = CantusFirmus.getAll();
            if (exercises.length > 0) {
                loadExercise(exercises[0].id);
            }
        }

        // Close examples modal
        document.getElementById('btnCloseExamples').addEventListener('click', () => {
            document.getElementById('examplesModal').classList.remove('active');
        });

        document.getElementById('examplesModal').addEventListener('click', (e) => {
            if (e.target.id === 'examplesModal') {
                e.target.classList.remove('active');
            }
        });

        // Initialize Schoenberg examples list
        populateSchoenbergExamplesList();

        // Instrument selector
        document.getElementById('instrumentSelect').addEventListener('change', (e) => {
            loadInstrument(e.target.value);
        });

        // Export to MusicXML
        document.getElementById('btnExport').addEventListener('click', exportMusicXML);

        // Position toggle
        document.querySelectorAll('[data-position]').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('[data-position]').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                state.cpPosition = btn.dataset.position;

                // Clear and redraw
                state.counterpoint = new Array(state.currentExercise.notes.length).fill(null);
                state.history = [];
                draw();
                validatePartial();
            });
        });

        // Keyboard shortcuts - canvas specific (arrows, delete)
        canvas.addEventListener('keydown', (e) => {
            if (!state.currentExercise) return;

            // Block note editing when viewing Schoenberg examples
            // But allow Space for playback and navigation
            const allowedInExampleMode = ['Space', 'Escape'];
            if (examplesState.isViewingExample && !allowedInExampleMode.includes(e.code)) {
                // Allow Escape to close modal if open
                if (e.code === 'Escape') {
                    document.getElementById('examplesModal').classList.remove('active');
                }
                return;
            }

            const noteCount = state.currentExercise.notes.length;

            // Arrow navigation
            if (e.code === 'ArrowLeft') {
                e.preventDefault();
                if (state.selectedBeat > 0) {
                    state.selectedBeat--;
                    draw();
                }
            } else if (e.code === 'ArrowRight') {
                e.preventDefault();
                if (state.selectedBeat < noteCount - 1) {
                    state.selectedBeat++;
                    draw();
                }
            } else if (e.code === 'ArrowUp') {
                e.preventDefault();
                // Shift+‚Üë = chromatic (semitone), normal = diatonic
                moveNoteAtSelectedBeat(1, e.shiftKey);
            } else if (e.code === 'ArrowDown') {
                e.preventDefault();
                // Shift+‚Üì = chromatic (semitone), normal = diatonic
                moveNoteAtSelectedBeat(-1, e.shiftKey)
            } else if (e.code === 'Delete' || e.code === 'Backspace') {
                e.preventDefault();
                deleteNoteAtSelectedBeat();
            } else if (e.code === 'Tab') {
                e.preventDefault();
                // Tab advances, Shift+Tab goes back
                if (e.shiftKey) {
                    if (state.selectedBeat > 0) {
                        state.selectedBeat--;
                        draw();
                    }
                } else {
                    if (state.selectedBeat < noteCount - 1) {
                        state.selectedBeat++;
                        draw();
                    }
                }
            } else if (e.code === 'Space') {
                e.preventDefault();
                playExercise();
            }
        });

        // Global keyboard shortcuts (work anywhere)
        document.addEventListener('keydown', (e) => {
            if (e.code === 'Enter') {
                validateFull();
            } else if (e.code === 'Escape') {
                document.getElementById('btnClear').click();
            } else if (e.ctrlKey && e.code === 'KeyZ') {
                e.preventDefault();
                document.getElementById('btnUndo').click();
            }
        });

        function moveNoteAtSelectedBeat(direction, chromatic = false) {
            if (state.selectedBeat === null) return;

            const currentNote = state.counterpoint[state.selectedBeat];
            const cfNote = state.currentExercise.notes[state.selectedBeat];

            // Save history
            state.history.push([...state.counterpoint]);

            if (!currentNote) {
                // No note yet, create one based on CF position
                // Start at a consonant interval from CF
                const cfMidi = Pitch.toMidi(cfNote);
                let startMidi;

                if (state.cpPosition === 'upper') {
                    // Start at octave above CF
                    startMidi = cfMidi + 12;
                } else {
                    // Start at octave below CF
                    startMidi = cfMidi - 12;
                }

                state.counterpoint[state.selectedBeat] = Pitch.fromMidi(startMidi);
            } else if (chromatic) {
                // Chromatic movement: move by semitone (for accidentals)
                const currentMidi = Pitch.toMidi(currentNote);
                const newMidi = currentMidi + direction;

                // Clamp to reasonable range
                if (newMidi >= 36 && newMidi <= 84) {  // C2 to C6
                    state.counterpoint[state.selectedBeat] = Pitch.fromMidi(newMidi);
                }
            } else {
                // Diatonic movement: move by scale step
                const currentMidi = Pitch.toMidi(currentNote);
                const key = state.currentExercise.key;
                const mode = state.currentExercise.mode;

                // Get all diatonic notes in a reasonable range
                const diatonicNotes = Scale.getDiatonicRange(key, mode, 'C2', 'C7');
                const currentIndex = diatonicNotes.findIndex(n => Pitch.toMidi(n) === currentMidi);

                if (currentIndex !== -1) {
                    const newIndex = currentIndex + direction;
                    if (newIndex >= 0 && newIndex < diatonicNotes.length) {
                        state.counterpoint[state.selectedBeat] = diatonicNotes[newIndex];
                    }
                } else {
                    // Note not in scale (has accidental), move by semitone to next note
                    // Then snap to diatonic if not using chromatic mode
                    let newMidi = currentMidi + direction;
                    state.counterpoint[state.selectedBeat] = Pitch.fromMidi(newMidi);
                }
            }

            // Play the note
            playCurrentNote();

            draw();
            validatePartial();
        }

        function deleteNoteAtSelectedBeat() {
            if (state.selectedBeat === null) return;
            if (!state.counterpoint[state.selectedBeat]) return;

            state.history.push([...state.counterpoint]);
            state.counterpoint[state.selectedBeat] = null;
            draw();
            validatePartial();
        }

        function playCurrentNote() {
            if (!state.counterpoint[state.selectedBeat]) return;

            initAudio();
            const note = state.counterpoint[state.selectedBeat];
            playNote(note, state.audioContext.currentTime, 0.3);

            // Also play CF note for context
            const cfNote = state.currentExercise.notes[state.selectedBeat];
            playNote(cfNote, state.audioContext.currentTime, 0.3);
        }

        // ==================== INIT ====================
        function init() {
            setupCanvas();
            populateExerciseList();

            // Load first exercise
            const exercises = CantusFirmus.getAll();
            if (exercises.length > 0) {
                loadExercise(exercises[0].id);
            }
        }

        init();

        // Debounced resize handler
        let resizeTimeout;
        window.addEventListener('resize', () => {
            clearTimeout(resizeTimeout);
            resizeTimeout = setTimeout(() => {
                setupCanvas();
                draw();
            }, 100);
        });
    </script>
</body>
</html>
